# 多配置管理与端口跳跃支持更新

## 📋 更新内容

### 1. ✨ 多配置管理系统

#### 功能特性
- **多配置支持**：可以保存和管理多个Hysteria配置
- **快速切换**：点击展开配置列表，一键切换不同配置
- **配置复制**：复制当前配置快速创建新配置
- **配置删除**：删除不需要的配置（至少保留一个）
- **配置命名**：为每个配置设置独立的名称

#### 使用方式
1. **查看配置列表**
   - 点击顶部配置卡片右侧的下拉按钮（▼）
   - 显示所有已保存的配置

2. **切换配置**
   - 在配置列表中点击要使用的配置
   - 当前配置会高亮显示

3. **复制配置**
   - 点击顶部的"+"按钮
   - 自动创建当前配置的副本
   - 副本名称会添加"(副本)"后缀

4. **删除配置**
   - 在配置列表中点击配置右侧的"×"按钮
   - 无法删除当前正在使用的配置
   - 至少需要保留一个配置

5. **编辑配置名称**
   - 在"基础配置"部分顶部
   - 修改"配置名称"字段
   - 点击"保存配置"生效

### 2. 🔀 端口跳跃范围支持

#### 新特性
服务器地址现在支持**端口范围格式**，用于配合端口跳跃功能：

**格式示例**：
```
example.com:30000-50000
domain.net:40000-45000
```

#### 验证规则
- ✅ 支持单端口：`example.com:443`
- ✅ 支持端口范围：`example.com:30000-50000`
- ✅ 端口号范围：1-65535
- ✅ 起始端口必须小于结束端口

#### 配置说明
当使用端口范围时：
1. **服务器地址**：填写 `domain.com:startPort-endPort`
2. **端口跳跃间隔**：在"高级选项"中设置跳跃间隔（秒）
3. **服务器要求**：服务器端必须支持端口跳跃功能

#### 示例配置
```yaml
# 单端口模式（传统）
server: example.com:443

# 端口跳跃模式（新）
server: example.com:30000-50000
```

对应的高级配置：
- 端口跳跃间隔：30秒（推荐）
- 客户端每30秒自动切换到范围内的随机端口

### 3. 🗂️ 数据模型更新

#### HysteriaConfigV2 新增字段
```kotlin
val id: String              // 配置唯一ID
val name: String            // 配置名称
val server: String          // 支持端口范围格式
```

#### ConfigListItem 配置列表项
```kotlin
data class ConfigListItem(
    val id: String,         // 配置ID
    val name: String,       // 配置名称
    val server: String,     // 服务器地址
    val lastUsed: Long      // 最后使用时间
)
```

### 4. 🎨 UI改进

#### 配置选择器卡片
- **顶部显示**：当前配置名称和服务器地址
- **操作按钮**：
  - ➕ 复制配置
  - ▼ 展开/收起配置列表

#### 配置列表展示
- **高亮当前配置**：使用主题色背景
- **显示配置信息**：名称 + 服务器地址
- **配置数量统计**：显示"所有配置 (N)"
- **删除按钮**：非当前配置显示删除图标

#### 服务器地址输入
- **增强提示**：说明支持端口范围格式
- **示例占位符**：`example.com:443 或 example.com:30000-50000`
- **验证反馈**：实时验证格式正确性

### 5. ⚙️ 验证增强

#### 端口验证逻辑
```kotlin
// 单端口验证
if (!contains("-")) {
    port in 1..65535
}

// 端口范围验证
if (contains("-")) {
    startPort < endPort
    both in 1..65535
}
```

#### 错误提示（中文）
- ❌ "端口范围格式错误，应为 port1-port2"
- ❌ "端口范围必须是数字"
- ❌ "端口号必须在 1-65535 之间"
- ❌ "起始端口必须小于结束端口"

## 📱 使用场景

### 场景1：测试环境配置管理
```
配置1：开发服务器
- 名称：开发环境
- 服务器：dev.example.com:443

配置2：测试服务器
- 名称：测试环境
- 服务器：test.example.com:443
```

### 场景2：不同地区服务器
```
配置1：香港节点
- 名称：HK01
- 服务器：hk1.example.com:443

配置2：日本节点
- 名称：JP01
- 服务器：jp1.example.com:443
```

### 场景3：端口跳跃配置
```
配置：抗封锁配置
- 名称：端口跳跃
- 服务器：example.com:30000-50000
- 端口跳跃间隔：30秒
- 混淆：启用
```

## 🔄 配置迁移

### 从旧版本升级
1. **自动迁移**：首次启动时自动导入旧配置
2. **配置名称**：旧配置命名为"导入配置"
3. **完全兼容**：所有旧配置数据完整保留

### 数据存储
- **内存管理**：所有配置保存在内存中
- **持久化**：当前配置自动保存到DataStore
- **未来计划**：将支持完整的多配置持久化

## 📦 技术实现

### 配置管理
```kotlin
// ViewModel中的配置存储
private val allConfigs = mutableMapOf<String, HysteriaConfigV2>()

// 配置操作
fun onConfigSelected(configId: String)
fun onConfigDeleted(configId: String)
fun onConfigDuplicated()
fun onConfigV2Changed(newConfigData: HysteriaConfigV2)
```

### 状态管理
```kotlin
data class UiState(
    val configDataV2: HysteriaConfigV2,      // 当前配置
    val configList: List<ConfigListItem>,    // 配置列表
    ...
)
```

## ⚠️ 注意事项

### 端口跳跃使用
1. **服务器支持**：确保服务器开启端口跳跃功能
2. **端口范围**：建议使用较大范围（如10000个端口）
3. **跳跃间隔**：推荐30-60秒，避免频繁切换
4. **防火墙规则**：确保端口范围全部开放

### 配置管理
1. **配置数量**：建议不超过10个配置
2. **命名规范**：使用有意义的名称便于识别
3. **定期清理**：删除不再使用的配置
4. **备份重要配置**：使用复制功能创建备份

### 兼容性
- ✅ 向后兼容旧版配置
- ✅ 支持传统单端口模式
- ✅ 端口范围为可选功能
- ✅ 不影响现有VPN服务

## 🚀 构建信息

**版本**：2.6.5-multiconfig  
**构建时间**：2025-12-08 18:15  
**APK位置**：`app/build/outputs/apk/release/`

### APK文件
- **app-universal-release.apk** - 34.5 MB（推荐）
- **app-arm64-v8a-release.apk** - 9.7 MB
- **app-armeabi-v7a-release.apk** - 9.9 MB
- **app-x86_64-release.apk** - 10.3 MB
- **app-x86-release.apk** - 10.6 MB

## 🎯 后续计划

- [ ] 配置导入/导出功能
- [ ] 配置持久化存储（JSON）
- [ ] 配置分组管理
- [ ] 配置排序功能
- [ ] 最近使用配置
- [ ] 配置搜索功能
- [ ] 批量配置导入
- [ ] 配置共享（二维码）

## 📝 使用示例

### 创建新配置
1. 在当前配置基础上修改参数
2. 点击"+"按钮复制配置
3. 修改配置名称（如"新节点"）
4. 修改服务器地址
5. 点击"保存配置"

### 配置端口跳跃
1. 服务器地址：`example.com:30000-50000`
2. 展开"高级选项"
3. 端口跳跃间隔：设置为30
4. 保存配置

### 快速切换节点
1. 点击顶部配置卡片的▼按钮
2. 在列表中选择目标配置
3. 自动切换，无需重新输入

---

**更新日期**：2025-12-08  
**版本**：2.6.5-multiconfig  
**状态**：✅ 已测试，可用于生产环境
